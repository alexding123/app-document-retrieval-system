<!DOCTYPE html>
<html>
<head>
  <title>APP文件检索系统</title>

<script src="https://github.com/alexding123/app-document-retrieval-system/blob/main/js/docxtemplater.js"></script>
<script src="https://github.com/alexding123/app-document-retrieval-system/blob/main/js/jszip.min.js"></script>
<script src="https://github.com/alexding123/app-document-retrieval-system/blob/main/js/pdf.js"></script>
<script src="https://github.com/alexding123/app-document-retrieval-system/blob/main/js/pdf.worker.js"></script>

</head>
<body>
  <h2>APP文件检索系统</h2>

  <label for="folder">选择查询目录：</label>
  <input type="file" id="folder" webkitdirectory directory multiple>
  
  <br><br>
  
  <label for="keyword">输入查询关键字：</label>
  <input type="text" id="keyword">
  <button onclick2="searchFiles()">搜索</button>
  <button onclick2="searchFilesByKeywordFromButton()">查询2</button>
  
  <br><br>
  
  <ul id="results"></ul>
  
  <br><br>
  
  <button onclick2="saveSelectedResults()">保存选中结果到文本并下载</button>
  
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    form {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }
    input[type="text"], input[type="file"], select {
      margin: 10px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    input[type="submit"], button {
      margin: 10px;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    input[type="submit"]:hover, button:hover {
      background-color: #0069d9;
    }
  </style>

  <script>
    let indexedFiles = [];
    let selectedResults = [];

    // 建立索引
    function indexFiles(files) {
      indexedFiles = [];
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.name.endsWith('.pdf') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
          indexedFiles.push(file);
        }
      }
      
      console.log('已建立索引的文件：', indexedFiles);
    }

    // 搜索文件
    function searchFiles() {
      const keyword = document.getElementById('keyword').value;
      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = '';
      
      if (keyword.trim().length === 0) {
        return;
      }
      
      const matchedFiles = indexedFiles.filter(file => file.name.toLowerCase().includes(keyword.toLowerCase()));
      
      for (let i = 0; i < matchedFiles.length; i++) {
        const li = document.createElement('li');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = matchedFiles[i].name;
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            selectedResults.push(this.value);
          } else {
            const index = selectedResults.indexOf(this.value);
            if (index > -1) {
              selectedResults.splice(index, 1);
            }
          }
        });
        
        li.appendChild(checkbox);
        li.appendChild(document.createTextNode(matchedFiles[i].name));
        resultsContainer.appendChild(li);
      }
    }

    // 新增的功能：搜索PDF和Word文件关键字
    function searchFilesByKeyword(keyword) {
      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = '';

      if (keyword.trim().length === 0) {
        return;
      }

      const matchedFiles = indexedFiles.filter(file => file.name.toLowerCase().endsWith('.pdf') || file.name.toLowerCase().endsWith('.doc') || file.name.toLowerCase().endsWith('.docx'));

      for (let i = 0; i < matchedFiles.length; i++) {
        const file = matchedFiles[i];
        const li = document.createElement('li');
        li.appendChild(document.createTextNode(file.name));
        resultsContainer.appendChild(li);

        if (file.name.toLowerCase().endsWith('.pdf')) {
          searchPdfFile(file, keyword, li);
        } else {
          searchWordFile(file, keyword, li);
        }
      }
    }

    // 在 PDF 文件中搜索关键字
    function searchPdfFile(file, keyword, li) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const typedArray = new Uint8Array(event.target.result);
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://github.com/alexding123/app-document-retrieval-system/blob/main/js/pdf.worker.js';

        pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
          const maxPages = pdf.numPages;
          let totalMatches = 0;

          for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
            pdf.getPage(pageNum).then(function(page) {
              page.getTextContent().then(function(textContent) {
                const textItems = textContent.items;
                let foundMatches = false;

                for (let i = 0; i < textItems.length; i++) {
                  const text = textItems[i].str.toLowerCase();
                  if (text.includes(keyword.toLowerCase())) {
                    const matchSpan = document.createElement('span');
                    matchSpan.style.backgroundColor = 'yellow';
                    matchSpan.appendChild(document.createTextNode(text + ' '));
                    li.appendChild(matchSpan);
                    foundMatches = true;
                    totalMatches++;
                  }
                }

                if (!foundMatches) {
                  const noMatchSpan = document.createElement('span');
                  noMatchSpan.style.color = 'red';
                  noMatchSpan.appendChild(document.createTextNode('关键字未找到'));
                  li.appendChild(noMatchSpan);
                }
              });
            });
          }

          const matchesInfo = document.createElement('span');
          matchesInfo.style.color = 'green';
          matchesInfo.appendChild(document.createTextNode(' - 匹配结果: ' + totalMatches + ' 个'));
          li.appendChild(matchesInfo);
        });
      };

      reader.readAsArrayBuffer(file);
    }

    // 在 Word 文件中搜索关键字
    function searchWordFile(file, keyword, li) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const arrayBuffer = event.target.result;
        const docxtemplater = window['Docxtemplater'].Docxtemplater;
        const JSZip = window['JSZip'].JSZip;

        JSZip.loadAsync(arrayBuffer).then(function(zip) {
          const contentXml = zip.file('word/document.xml').async('string');

          contentXml.then(function(content) {
            const templater = new docxtemplater().loadContent(content);
            templater.getFullText().then(function(fullText) {
              const regex = new RegExp(keyword, 'gi');
              let match;
              let totalMatches = 0;

              while ((match = regex.exec(fullText)) !== null) {
                const matchIndex = match.index;
                const matchedText = match[0];

                const startTag = '<span style="background-color: yellow">';
                const endTag = '</span>';
                const highlightedText = fullText.slice(0, matchIndex) + startTag + matchedText + endTag + fullText.slice(matchIndex + matchedText.length);
                fullText = highlightedText;
                totalMatches++;
              }

              const htmlContent = fullText.replace(/(<([^>]+)>)/gi, '');

              const matchSpan = document.createElement('span');
              matchSpan.style.backgroundColor = 'yellow';
              matchSpan.innerHTML = htmlContent + ' ';
              li.appendChild(matchSpan);

              const matchesInfo = document.createElement('span');
              matchesInfo.style.color = 'green';
              matchesInfo.appendChild(document.createTextNode(' - 匹配结果: ' + totalMatches + ' 个'));
              li.appendChild(matchesInfo);
            });
          });
        });
      };

      reader.readAsArrayBuffer(file);
    }

    // 新增的功能：通过按钮触发搜索
    function searchFilesByKeywordFromButton() {
      const keyword = document.getElementById('keyword').value;
      searchFilesByKeyword(keyword);
    }
    // 输出错误信息
function handleError(error) {
  console.error('出现错误:', error);
}
    process.on('unhandledRejection', handleError);
  </script>
</body>
</html>